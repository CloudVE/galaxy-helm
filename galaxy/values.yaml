# Default values for galaxy.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

image:
  repository: galaxy/galaxy
  tag: 19.05
  pullPolicy: IfNotPresent

nameOverride: ""
fullnameOverride: ""

service:
  type: NodePort
  port: 8090

webHandlers:
  replicaCount: 1

jobHandlers:
  replicaCount: 1

rbac:
  enabled: true

persistence:
  enabled: true
  name: &pvcname galaxy-pvc
  # annotations: {}
  # storageClass:
  accessMode: ReadWriteMany
  size: 10Gi

ingress:
  enabled: true
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  path: /galaxy
  hosts:
    - ~
    # - host: ~
    #   paths: ["/"]
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

nodeSelector: {}

tolerations: []

affinity: {}

postgresql:
  enabled: true
  username: galaxydbuser
  password: 42
  nameOverride: galaxy-postgres
  initdbScriptsConfigMap: "{{ .Release.Name }}-galaxy-initdb"
  persistence:
    enabled: true

cvmfs:
  enabled: true
  data:
    pvc:
      storage: 1Gi
    mountPath: /cvmfs/data.galaxyproject.org
  main:
    pvc:
      storage: 1Gi
    mountPath: /cvmfs/main.galaxyproject.org

# All files will be relative to `/galaxy/server/config/` directory
configs:
  job_conf.xml: |
    <job_conf>
        <plugins>
            <plugin id="local" type="runner" load="galaxy.jobs.runners.local:LocalJobRunner" workers="4" />
            <plugin id="k8s" type="runner" load="galaxy.jobs.runners.kubernetes:KubernetesJobRunner">
              <param id="k8s_use_service_account">true</param>
              <param id="k8s_persistent_volume_claims">{{ .Release.Name }}-{{ .Values.persistence.name }}:/galaxy/server/database,{{ template "galaxy.fullname" . }}-cvmfs-gxy-data-pvc:{{ .Values.cvmfs.data.mountPath }}</param>
              <param id="k8s_namespace">{{ .Release.Namespace }}</param>
              <!-- Must be DNS friendly and less than 20 characters -->
              <param id="k8s_galaxy_instance_id">{{ .Release.Namespace }}</param>
              <param id="k8s_run_as_user_id">101</param>
              <param id="k8s_run_as_group_id">101</param>
              <param id="k8s_fs_group_id">101</param>
              <param id="k8s_supplemental_group_id">101</param>
              <param id="k8s_pull_policy">IfNotPresent</param>
              <param id="k8s_cleanup_job">always</param>
            </plugin>
        </plugins>
        <handlers assign_with="db-skip-locked" />
        <destinations default="local_k8s">
            <destination id="local" runner="local"/>
            <destination id="local_k8s" runner="k8s">
              <param id="enabled">true</param>
              <param id="docker_enabled">true</param>
              <param id="docker_sudo">False</param>
              <param id="docker_default_container_id">busybox:ubuntu-14.04</param>
            </destination>
        </destinations>
        <tools>
          <!-- Should not be needed in the long run. -->
          <!-- https://github.com/galaxyproject/galaxy/blob/1279a2074c566564bf8b9ad90883b2e044adec57/lib/galaxy/tools/__init__.py#L113 -->
          <tool id="upload1" destination="local" />
          <tool id="send_to_cloud" destination="local" />
          <tool id="__DATA_FETCH__" destination="local" />
          <tool id="vcf_to_maf_customtrack1" destination="local" />
          <tool id="laj_1" destination="local" />
          <tool id="meme_fimo" destination="local" />
          <tool id="secure_hash_message_digest" destination="local" />
          <tool id="join1" destination="local" />
          <tool id="gff2bed1" destination="local" />
          <tool id="gff_filter_by_feature_count" destination="local" />
          <tool id="aggregate_scores_in_intervals2" destination="local" />
          <tool id="Interval_Maf_Merged_Fasta2" destination="local" />
          <tool id="GeneBed_Maf_Fasta2" destination="local" />
          <tool id="maf_stats1" destination="local" />
          <tool id="Interval2Maf1" destination="local" />
          <tool id="Interval2Maf_pairwise1" destination="local" />
          <tool id="MAF_To_Interval1" destination="local" />
          <tool id="MAF_filter" destination="local" />
          <tool id="MAF_To_Fasta1" destination="local" />
          <tool id="MAF_Reverse_Complement_1" destination="local" />
          <tool id="MAF_split_blocks_by_species1" destination="local" />
          <tool id="MAF_Limit_To_Species1" destination="local" />
          <tool id="maf_by_block_number1" destination="local" />
          <tool id="wiggle2simple1" destination="local" />
          <tool id="CONVERTER_bed_to_fli_0" destination="local" />
          <tool id="CONVERTER_fastq_to_fqtoc0" destination="local" />
          <tool id="CONVERTER_gff_to_fli_0" destination="local" />
          <tool id="CONVERTER_gff_to_interval_index_0" destination="local" />
          <tool id="CONVERTER_maf_to_fasta_0" destination="local" />
          <tool id="CONVERTER_maf_to_interval_0" destination="local" />
          <tool id="CONVERTER_wiggle_to_interval_0" destination="local" />
          <tool id="CONVERTER_tar_to_directory" destination="local" />
          <tool id="qualityFilter" destination="local" />
          <tool id="winSplitter" destination="local" />
          <tool id="pileup_interval" destination="local" />
          <tool id="count_gff_features" destination="local" />
          <tool id="Convert characters1" destination="local" />
          <tool id="lastz_paired_reads_wrapper" destination="local" />
          <tool id="subRate1" destination="local" />
          <tool id="substitutions1" destination="local" />
          <tool id="sam_pileup" destination="local" />
          <tool id="find_diag_hits" destination="local" />
          <tool id="cufflinks" destination="local" />
          <tool id="gops_intersect_1" destination="local" />
          <tool id="tabular_to_dbnsfp" destination="local" />
          <tool id="column_join" destination="local" />
          <tool id="gd_coverage_distributions" destination="local" />
          <tool id="gd_dpmix" destination="local" />
          <tool id="gd_pca" destination="local" />
          <tool id="gd_phylogenetic_tree" destination="local" />
          <tool id="gd_population_structure" destination="local" />
          <tool id="gd_prepare_population_structure" destination="local" />
          <tool id="genomespace_importer" destination="local" />
        </tools>
    </job_conf>
  galaxy.yml: |
    uwsgi:
      virtualenv: /galaxy/server/.venv
      processes: 1
      http: 0.0.0.0:8080
      static-map: /static/style=/galaxy/server/static/style/blue
      static-map: /static=/galaxy/server/static
      static-map: /favicon.ico=/galaxy/server/static/favicon.ico
      pythonpath: /galaxy/server/lib
      thunder-lock: true
      manage-script-name: true
      mount: {{.Values.ingress.path}}=galaxy.webapps.galaxy.buildapp:uwsgi_app()
      buffer-size: 16384
      offload-threads: 2
      threads: 4
      die-on-term: true
      master: true
      hook-master-start: unix_signal:2 gracefully_kill_them_all
      enable-threads: true
      py-call-osafterfork: true
    galaxy:
      database_connection: 'postgresql://{{.Values.postgresql.username}}:{{.Values.postgresql.password}}@{{ template "galaxy-postgresql.fullname" . }}/galaxy'
      integrated_tool_panel_config: "/galaxy/server/config/editable/integrated_tool_panel.xml"
      tool_config_file: "{{ .Values.cvmfs.main.mountPath }}/config/tool_conf.xml,{{ .Values.cvmfs.main.mountPath }}/config/shed_tool_conf.xml"
      tool_data_table_config_path: "{{ .Values.cvmfs.main.mountPath }}/config/shed_tool_data_table_conf.xml,{{.Values.cvmfs.data.mountPath}}/managed/location/tool_data_table_conf.xml"
      tool_dependency_dir: "{{ .Values.cvmfs.main.mountPath }}/deps"
      builds_file_path: "{{.Values.cvmfs.data.mountPath}}/managed/location/builds.txt"
      datatypes_config_file: "{{ .Values.cvmfs.main.mountPath }}/config/datatypes_conf.xml"
      containers_resolvers_config_file: "/galaxy/server/config/container_resolvers_conf.xml"
  container_resolvers_conf.xml: |
    <containers_resolvers>
      <explicit />
      <mulled />
    </containers_resolvers>
  # Although this is only one line, the multi-line entry allows us to avoid wrapping
  # the entire expression in quotes, which would need to be removed in the configmap
  integrated_tool_panel.xml: |
    {{- (.Files.Get "files/configs/integrated_tool_panel.xml") }}
